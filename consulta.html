<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultant</title>
    <link rel="stylesheet" href="style_consulta.css">
</head>
<body style="background-color:#dbd0b7 ;">
    <header>
        <nav>
        <Ul>
            <li>
                <a href="index.html" title="Inicio">Inicio</a>
            </li>
            <li>
                <a href="analise.html" title="Analise">Analise</a>
            </li>
            <li class="page-m">
                <a href="consulta.html" title="Consulta">Consultar</a>
            </li>
            <li>
                <a href="sobre.html" title="Sobre">Sobre</a>
            </li>
        </Ul> 
        </nav>
    </header>
<section style=" margin-top: -40px; margin-bottom: 200px;">
     <div style="width: 100%;">
<div style="
    position:relative; 
    margin-top:7%; 
    margin-left:7%;
    width:max-content;
">

    <!-- TÍTULO -->
    <p style="
        font-size:74px;
        font-family:'Times New Roman', Times, serif;
        margin:0;
        white-space:nowrap;
    ">
        <b>Sua solução em um clique</b>
    </p>

    <!-- HEXÁGONO INDEPENDENTE (ABSOLUTE) -->
    <div style="
        position:absolute;
        top:100%;
        left:100%;
        transform:translateY(-50%) translateX(20px); 
        
        /* agora você pode aumentar à vontade */
        width: 450px;
        aspect-ratio:300/260;
    ">
        <div style="
            width:100%; height:100%;
            background-color:#465d39;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            box-shadow:0 10px 24px rgba(0,0,0,0.25);
        "></div>

        <img src="img/Logo_S&S.png" style="
            position:absolute; top:50%; left:50%;
            width:110%; transform:translate(-50%, -50%);
            border-radius:12px;
        ">
    </div>

</div>
    <p>
        De forma rápido!
    </p>
    <img src="img/LogoSENAC.png" alt="LogoSENAC" style="width: 74px; height: auto; margin-left: 7%; padding-top: 25px;">
    </div>
</section>
<section class="analise-wrap" style="background-color:#2f4b2f;">
<div class="wrap">
    <div class="layout">
      <!-- ESQUERDA: Câmera -->
      <section class="panel">
        <h2>Imagem ao vivo</h2>
        <div id="cam-wrap">
          <video id="video" autoplay playsinline muted></video>
          <div class="row">
            <button id="btn-start" type="button">Iniciar câmera</button>
            <button id="btn-switch" type="button" class="secondary" title="Alternar entre frontal/traseira">Trocar câmera</button>
            <button id="btn-capture" type="button">Capturar</button>
            <button id="btn-stop" type="button" class="secondary">Parar</button>
          </div>
          <div class="note">Dica: em celulares, use a câmera traseira (botão “Trocar câmera”). Requer HTTPS ou <code>localhost</code>.</div>

          <h2 style="margin-top:8px">Última captura</h2>
          <img id="shot" alt="Pré-visualização da captura">
        </div>
      </section>

      <!-- DIREITA: Tabela de resultados -->
      <aside class="panel">
        <h2>Resultados da IA</h2>
        <table>
          <thead>
            <tr>
              <th>Campo</th>
              <th>Valor</th>
              <th>Confiança</th>
            </tr>
          </thead>
          <tbody id="results-body">
            <!-- linhas serão inseridas via JS após resposta do backend -->
            <tr><td>material</td><td></td><td></td></tr>
            <tr><td>local</td><td></td><td></td></tr>
            <tr><td>data</td><td></td><td></td></tr>
            <tr><td>exatidão</td><td></td><td></td></tr>
          </tbody>
        </table>
        <div id="status">Aguardando captura…</div>
        <div id="error"></div>
      </aside>
    </div>
  </div>
</section>
  <!-- Canvas oculto só para gerar a imagem da captura -->
  <canvas id="canvas" style="display:none"></canvas>

  <script>
    let stream=null, currentFacing='environment'; // environment | user
    const API_URL = 'http://localhost:5000/api/upload';

    async function startCamera() {
      stopCamera();
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: currentFacing }, width: { ideal: 1280 }, height: { ideal: 960 } },
          audio: false
        });
        document.getElementById('video').srcObject = stream;
        setStatus('Câmera iniciada.');
        setError('');
      }catch(e){
        setError('Não foi possível acessar a câmera: '+ e.message);
      }
    }
    function stopCamera(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      document.getElementById('video').srcObject=null;
      setStatus('Câmera parada.');
    }
    function switchCamera(){
      currentFacing = (currentFacing==='environment' ? 'user' : 'environment');
      startCamera();
    }
    async function captureAndSend(){
      const video = document.getElementById('video');
      if(!video.srcObject){ setError('Inicie a câmera antes de capturar.'); return; }

      // desenha frame no canvas
      const canvas = document.getElementById('canvas');
      // mantém proporção 4:3
      const w = video.videoWidth || 1280, h = video.videoHeight || 960;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);

      // preview
      document.getElementById('shot').src = canvas.toDataURL('image/jpeg', 0.9);

      // envia para backend
      setStatus('Enviando imagem para análise…');
      setError('');
      canvas.toBlob(async (blob)=>{
        const form = new FormData();
        form.append('imagem', blob, 'captura.jpg');

        try{
          const resp = await fetch(API_URL, { method:'POST', body: form });
          
          const data = await resp.json();

          if(!resp.ok){ 
            throw new Error(`HTTP ${resp.status}: ${data.mensagem || 'Erro desconhecido'}`); 
          }

          if (data.dados_lidos) {
            renderTable(data.dados_lidos);
            setStatus('Análise concluída.');
          } else {
            throw new Error(data.mensagem || 'API não retornou o objeto "dados_lidos"');
          }

        }catch(e){
          console.error(e);
          setError('Falha ao analisar: '+ e.message);
          setStatus('Erro na análise.');
        }
      }, 'image/jpeg', 0.9);
    }

    // CORREÇÃO 4: Reescrever a função renderTable para aceitar um OBJETO (dados_lidos)
    function renderTable(dataObject){
      const tbody = document.getElementById('results-body');
      tbody.innerHTML = '';
      
      if(!dataObject || Object.keys(dataObject).length === 0){
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Nenhum dado extraído. Verifique o treinamento da IA.</td></tr>';
        return;
      }
      
      // Itera sobre o objeto (ex: {Data: '10/10/2025', Item: 'Parafuso', ...})
      for (const [campo, valor] of Object.entries(dataObject)) {
        const tr = document.createElement('tr');
        
        // Formata o valor booleano (dos checkboxes) para ficar legível
        let valorFormatado = valor;
        if (typeof valor === 'boolean') {
            valorFormatado = valor ? 'Sim (Marcado)' : 'Não';
        }

        // O seu Python não retorna confiança por campo (o que é normal), então removemos
        tr.innerHTML = `<td>${campo}</td><td>${valorFormatado}</td><td>OK</td>`;
        tbody.appendChild(tr);
      }
    }

    function setStatus(t){ document.getElementById('status').textContent = t; }
    function setError(t){ document.getElementById('error').textContent = t; }

    // bindings
    document.getElementById('btn-start').addEventListener('click', startCamera);
    document.getElementById('btn-stop').addEventListener('click', stopCamera);
    document.getElementById('btn-switch').addEventListener('click', switchCamera);
    document.getElementById('btn-capture').addEventListener('click', captureAndSend);

    // tenta iniciar automaticamente (silencioso)
    if (navigator.mediaDevices && (location.protocol.startsWith('https') || location.hostname==='localhost')) {
      startCamera().catch(()=>{});
    }

  </script>
      <section style="margin: 200px 0px; text-align: center;">
        <h2 style="font-size: 36px; font-family: suez one, 'Times New Roman', Times, serif;">Consulta simples</h2>
        <p style="font-size: 18px; font-family: suez one, 'Times New Roman', Times, serif; max-width: 800px; margin: 0 auto;">
            Oferecemos soluções que facilitam suas consultas, proporcionando respostas rápidas e precisas para suas necessidades.
        </p>
    </section>
<section>
<footer style="
    width: 100%;
    padding: 24px 0px;
    background:rgba(47,75,47);
;
    color: #ffffff;
    font-family: Arial, sans-serif;
    font-size: 14px;
    text-align: center;
    border-top: 1px solid rgba(86,82,72,0.9);
">
    <p style="margin: 0; color: #dbd0b7;">&copy; 2025 <strong>S&S</strong>. Todos os direitos reservados.</p>
</footer>
</section>
</body>
</html>